---

layout: post
title: '[Spring]Stomp + SocketJS'
subtitle: '[Spring]Stomp + SocketJS'
categories: devlog
tags: stomp
comments: true

---

# 메시징 시스템
분리된 어플리케이션간 비동기적으로 신뢰성있게 통신

특징
- 메시지 생산자(producer),소비자(consumer)간 약한 결합성
- 동적이고 신뢰성있고 유연함
- 높은 확장성, 서로 다른 네트웤 사이의 쉬운 통합, 안정성

종류
1. Public-Subcribe 방식(Pub-Sub)  
    - 생산자가 토픽에 메시지를 보내면, 해당 토픽을 구독해놓은 모든 사용자들에게 메시지가 전송되는 방식

2. Point-To-Point 방식(PTP)
    - 큐를 통해서 메시지를 전달하고 튜를 통해서 메시지를 받는 방식
    모든 사람이 큐를 하나씩 가지고 보내는 사람이 목적지 큐를정해서 전송

# stomp


프레임 구조
```
COMMAND
header1 : value1
header2 : value2

Body^@
```

## client
메세지를 보내기 위한 명령
subscritbe,send
- console.log 예시
    clientA가 5번 채팅방을 구독할 때
    ```
    SUBSCRIBE
    destination: /topic/chat/room/5
    id: sub-1

    ^@
    ```
    cleintB에서 채팅 메시지를 보낼 때
    ```
    SEND
    destination: /pub/chat
    content-type: application/json

    {"chatRoomId": 5, "type": "MESSAGE", "writer": "clientB"}^@
    ```
- 사용하려면 destination이라는 헤더 필요  
    - destination   
        - 어디에 메시지 전송할지, 어디에서 메세지 구독하는지 알려주는 헤더
        - 값은 서버에서 정하는 규칙에 따라 어떤 문자열이든 가능
        - 라우팅 방향을 결정하는 prefix(일반적으로 쓰이는 destination 값)
            1. 서버측 annotated method방향
                - `/app/.../...`
            2. 브로커 방향
                - `/topic/.../...` 주소는 pub-sub 방식의 one to many일 때 사용  
                - `/queue/.../...` 주소는 point to point 방식의 one to one일 때 사용

클라이언트에서 서버로 SEND할 때 흐름
![image](https://user-images.githubusercontent.com/60701130/155841215-9a902eaa-ae5d-4389-a783-28493f22cc4d.png)

 
1.  클라이언트에서 destination에 /app 이라는 prefix를 주었을때 흐름

해당 request는 @messagemapping된 스프링 컨트롤러(simpAnnotationMethod)로 흘러가고 컨트롤러에서 메세지를 수신한 후 여러 작업들을 처리한 후에 /topic이라는 prefix를 통해 브로커에게 전달하면 브로커는  STOMP MESSAGE 메소드를 이용해서 특정 토픽을 구독하는 구독자들에게 reponse를 보낸다.

 

2.  클라이언트에서 destination에 /topic이라는 prefix를 주었을때 흐름

 

매핑된 스프링 컨트롤러를 안거치고 브로커에게 직접 접근하겠다는 뜻인데 주로 클라이언트가 subscribe를 할때 이 prefix를 사용하는 것으로 보인다. 계속 설명하지만  /topic 이라는 prefix를 쓰면 브로커에게 직접 전달되는데 이 경우 브로커가 직접 받아서 subscriber들 관리를 하는 것 같다.

  
